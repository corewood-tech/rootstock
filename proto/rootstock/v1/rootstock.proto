syntax = "proto3";

package rootstock.v1;

option go_package = "rootstock/web-server/proto/rootstock/v1;rootstockv1";

service HealthService {
  rpc Check(CheckRequest) returns (CheckResponse);
}

message CheckRequest {}

message CheckResponse {
  string status = 1;
}

// CampaignService manages scientific data collection campaigns.
service CampaignService {
  rpc CreateCampaign(CreateCampaignRequest) returns (CreateCampaignResponse);
  rpc PublishCampaign(PublishCampaignRequest) returns (PublishCampaignResponse);
  rpc ListCampaigns(ListCampaignsRequest) returns (ListCampaignsResponse);
  rpc GetCampaignDashboard(GetCampaignDashboardRequest) returns (GetCampaignDashboardResponse);
  rpc ExportCampaignData(ExportCampaignDataRequest) returns (ExportCampaignDataResponse);
}

// Campaign messages

message ParameterProto {
  string name = 1;
  string unit = 2;
  optional double min_range = 3;
  optional double max_range = 4;
  optional int32 precision = 5;
}

message RegionProto {
  string geo_json = 1;
}

message EligibilityProto {
  string device_class = 1;
  int32 tier = 2;
  repeated string required_sensors = 3;
  string firmware_min = 4;
}

message CampaignProto {
  string id = 1;
  string org_id = 2;
  string status = 3;
  optional string window_start = 4;
  optional string window_end = 5;
  string created_by = 6;
  string created_at = 7;
}

message CreateCampaignRequest {
  string org_id = 1;
  string created_by = 2;
  optional string window_start = 3;
  optional string window_end = 4;
  repeated ParameterProto parameters = 5;
  repeated RegionProto regions = 6;
  repeated EligibilityProto eligibility = 7;
}

message CreateCampaignResponse {
  CampaignProto campaign = 1;
}

message PublishCampaignRequest {
  string campaign_id = 1;
}

message PublishCampaignResponse {}

message ListCampaignsRequest {
  string status = 1;
  string org_id = 2;
  optional double longitude = 3;
  optional double latitude = 4;
  optional double radius_km = 5;
}

message ListCampaignsResponse {
  repeated CampaignProto campaigns = 1;
}

message GetCampaignDashboardRequest {
  string campaign_id = 1;
}

message GetCampaignDashboardResponse {
  string campaign_id = 1;
  int32 accepted_count = 2;
  int32 quarantine_count = 3;
}

message ExportedReadingProto {
  string pseudo_device_id = 1;
  string campaign_id = 2;
  double value = 3;
  string timestamp = 4;
  optional string geolocation = 5;
  string firmware_version = 6;
  string ingested_at = 7;
  string status = 8;
}

message ExportCampaignDataRequest {
  string campaign_id = 1;
  int32 limit = 2;
  int32 offset = 3;
}

message ExportCampaignDataResponse {
  repeated ExportedReadingProto readings = 1;
}

// OrgService manages organizations, roles, and user invitations.
service OrgService {
  rpc CreateOrg(CreateOrgRequest) returns (CreateOrgResponse);
  rpc NestOrg(NestOrgRequest) returns (NestOrgResponse);
  rpc DefineRole(DefineRoleRequest) returns (DefineRoleResponse);
  rpc AssignRole(AssignRoleRequest) returns (AssignRoleResponse);
  rpc InviteUser(InviteUserRequest) returns (InviteUserResponse);
}

// Org messages

message CreateOrgRequest {
  string name = 1;
}

message CreateOrgResponse {
  string org_id = 1;
  string name = 2;
}

message NestOrgRequest {
  string name = 1;
  string parent_org_id = 2;
}

message NestOrgResponse {
  string org_id = 1;
  string name = 2;
}

message DefineRoleRequest {
  string project_id = 1;
  string role_key = 2;
  string display_name = 3;
}

message DefineRoleResponse {
  string project_id = 1;
  string role_key = 2;
  string display_name = 3;
}

message AssignRoleRequest {
  string user_id = 1;
  string project_id = 2;
  repeated string role_keys = 3;
}

message AssignRoleResponse {
  string user_grant_id = 1;
  string user_id = 2;
  string project_id = 3;
  repeated string role_keys = 4;
}

message InviteUserRequest {
  string org_id = 1;
  string email = 2;
  string given_name = 3;
  string family_name = 4;
}

message InviteUserResponse {
  string user_id = 1;
  string email_code = 2;
}

// ScoreService provides scitizen contribution scores and gamification.
service ScoreService {
  rpc GetContribution(GetContributionRequest) returns (GetContributionResponse);
}

// DeviceService manages device registry operations for researchers/admins.
service DeviceService {
  rpc GetDevice(GetDeviceRequest) returns (GetDeviceResponse);
  rpc RevokeDevice(RevokeDeviceRequest) returns (RevokeDeviceResponse);
  rpc ReinstateDevice(ReinstateDeviceRequest) returns (ReinstateDeviceResponse);
  rpc EnrollInCampaign(EnrollInCampaignRequest) returns (EnrollInCampaignResponse);
}

// Score messages

message BadgeProto {
  string id = 1;
  string badge_type = 2;
  string awarded_at = 3;
}

message GetContributionRequest {
  string scitizen_id = 1;
}

message GetContributionResponse {
  string scitizen_id = 1;
  int32 volume = 2;
  double quality_rate = 3;
  double consistency = 4;
  int32 diversity = 5;
  double total = 6;
  string updated_at = 7;
  repeated BadgeProto badges = 8;
}

// Device messages

message DeviceProto {
  string id = 1;
  string owner_id = 2;
  string status = 3;
  string class = 4;
  string firmware_version = 5;
  int32 tier = 6;
  repeated string sensors = 7;
  optional string cert_serial = 8;
  string created_at = 9;
}

message GetDeviceRequest {
  string device_id = 1;
}

message GetDeviceResponse {
  DeviceProto device = 1;
}

message RevokeDeviceRequest {
  string device_id = 1;
}

message RevokeDeviceResponse {}

message ReinstateDeviceRequest {
  string device_id = 1;
}

message ReinstateDeviceResponse {}

message EnrollInCampaignRequest {
  string device_id = 1;
  string campaign_id = 2;
}

message EnrollInCampaignResponse {
  bool enrolled = 1;
  string reason = 2;
}

// AdminService provides platform administration operations.
service AdminService {
  rpc SuspendByClass(SuspendByClassRequest) returns (SuspendByClassResponse);
}

// Admin messages

message SuspendByClassRequest {
  string device_class = 1;
  string firmware_min = 2;
  string firmware_max = 3;
  string window_start = 4;
  string window_end = 5;
  string reason = 6;
}

message SuspendByClassResponse {
  int32 suspended_count = 1;
  int64 quarantined_readings = 2;
  int32 notified_scitizens = 3;
}
